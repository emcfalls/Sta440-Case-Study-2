---
title: "Elyse EDA"
author: "Elyse McFalls and Holly Cui"
date: "2023-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

## Questions/Comments
1. How can we tell what apparatus each all-around score relates to?
2. How will we create a model to predict the past competitions? The data we have from the newest set only contains 2022-2023 data and the older dataset only has data from the 2021 Olympics for women (only 4 have played/placed in top 5 in 2022/2023)
  a. Will need to get data for the current athletes 
3. Looks like we're dealing with sparse functional data 
4. Could predict a player's potential by comparing them to another player (i.e., we would find historically successful Olympic teams and see which current USA players are more similar to them) [link](https://onlinelibrary.wiley.com/doi/full/10.1002/sam.11436)
4. Instead of testing our model on these players, we should test it on other players that we can get a lot of data on (this paper tests their NBA points model by using players that retired  [link](https://docplayer.net/39444957-Forecasting-nba-player-performance-using-a-weibull-gamma-statistical-timing-model-abstract.html)) 
  a. paper also mentioned a Weibull-Gamma model to take into account time and used the covariate of if the player was having and off year or not (off being that they were injured)
5. Could use sparse functional data algorithms (i.e., ROPES and PACE)
  a. may be better since 1) gymnasts' careers aren't that long and 2) the point system changes every olympic season (or could add a covariate due to what cycle it is?)
  b. requires using the data from every observation to make the functions for player which may pull their predictions towards the mean -> the paper overcame this by finding players similar to the player of interest and use that data for predictions, "method of analogues." Found related players using ADA

### Assumptions
1. An athlete won't change their difficulty score since their last competition 
2. An athlete won't get tired (so they can partake in any competition they are eligible for)
3. An athlete who hasn't made the top 5 in any prior competition will not place in the olympics 
  a. use looser criteria for other countries because they may not rank high, but they will represent their country

```{r}
rawData2022_2023 %>%
  
```

```{r}
# data from Emily
df23 <- rawData2022_2023 %>%
  mutate(Date = sapply(strsplit(as.character(Date), "-"), tail, 1),
         Date = trimws(Date),                 # Trim leading and trailing spaces
         Date = sub(" *$", "", Date),         # Remove spaces at the end
         Date = gsub(" ", "-", Date))         # Replace remaining spaces with "-"
```

```{r}
# date split df
df_date <- data.frame(stringr::str_split_fixed(df23$Date, '-', n = 3))
colnames(df_date) <- c('Date_day', 'Date_month', 'Date_year')

# add to df column
df23 <- cbind(df23, df_date)
```

```{r}
df23 <- df23 %>%
  # formatting the date column
  mutate(Date = case_when(.default = paste0(Date_day, '-',  Date_month, '-', Date_year),
                          Date_month == 'Sept' ~ paste0(Date_day, '-Sep-', Date_year))) %>%
  mutate(Date = as.Date(Date, format = "%d-%b-%Y"), Year = Date_year) %>%
  # standardizing names and making a full name column
  mutate(LastName = toupper(LastName), FirstName = toupper(FirstName), 
         FullName = paste0(LastName, ' ', FirstName), 
         Date = as.Date(Date, format = "%d-%b-%Y")) %>%
  select(-Date_year, -Date_month, -Date_day, -LastName, -FirstName)
```

```{r}
# saving full dataframe
write.csv(df23, "cleaned data/full_data_2023.csv")
```


## Loading Data and Data Cleaning 

```{r}
df <- read.csv("cleaned data/data_2022_2023_cleaned.csv")
df_old <- read.csv("data/data_2017_2021.csv")
```


### Old Data
```{r}
# all of this data is from the 2021 Olympics
df_old %>%
  filter(Competition != "Olympic Games")
```

```{r}
# only has women
df_old %>%
  filter(Gender != 'w')
```


```{r}
df_old <- df_old %>%
  # removing day of the week and the Julys
  mutate(Date = case_when(is.na(as.numeric(substr(Date, 1, 1))) ~ substr(Date, 4, 15),
                          .default = substr(Date, 1, 15)),
         Date = toupper(Date),
         Date = case_when(.default = substr(Date, 1, 15),
                          substr(substr(Date, 4, 8), 4,4) == 'Y' ~ paste(substr(Date, 1,2), 'JUL', substr(Date, 8, 15))))
         
```

```{r}
# no NAs
sum(is.na(df_old$Date))
```


```{r}
# changing to date format 
df_old <- df_old %>%
  mutate(Date = as.Date(Date, format = "%d %b %Y"))
```


### Most Recent Data

```{r}
# date split df
df_date <- data.frame(stringr::str_split_fixed(df$Date, '-', n = 3))
colnames(df_date) <- c('Date_day', 'Date_month', 'Date_year')

# add to df column
df <- cbind(df, df_date)
```

```{r}
df <- df %>%
  # formatting the date column
  mutate(Date = case_when(.default = paste0(Date_day, '-',  Date_month, '-', Date_year),
                          Date_month == 'Sept' ~ paste0(Date_day, '-Sep-', Date_year))) %>%
  mutate(Date = as.Date(Date, format = "%d-%b-%Y"), Year = Date_year) %>%
  # standardizing names and making a full name column
  mutate(LastName = toupper(LastName), FirstName = toupper(FirstName), 
         FullName = paste0(LastName, ' ', FirstName), 
         Date = as.Date(Date, format = "%d-%b-%Y")) %>%
  select(-Date_year, -Date_month, -Date_day, -LastName, -FirstName)
```

```{r}
# vt1 and VT2 have a lot of NAs
# 33 NAs are from Croatia, GBR has 17 and PAN has 13
# 50 nas come from last year's world championships 
df %>%
  filter(is.na(Score)) %>%
  group_by(Competition) %>%
  count() %>%
  arrange(desc(n))
```


## Filtering USA Data

```{r}
df_usa <- df %>%
  filter(Country == 'USA')

df_old_usa <- df_old %>%
  filter(Country == 'USA')
```


```{r}
# competitions 
df_usa %>%
  select(Competition) %>%
  distinct()
```

```{r}
# athletes represented 
df_usa %>%
  select(FullName) %>%
  distinct()
```

```{r}
# athletes in the 2021 olympics
df_old_usa %>%
  select(LastName) %>%
  distinct()
```


## Scoring Trends for Female US Athletes

```{r}
# making data frame
df_usaw <- df_usa[df_usa['Gender'] == 'w',]
```

```{r}
df_usaw %>%
  select(FullName) %>%
  distinct()
```

### Relationship among AA scores

```{r}
df_usaw %>%
  select(FullName, Competition, Round, Score) %>%
  filter(Round == 'AAfinal')
```



### Relationship among apparatuses by athlete

```{r}
# checking best scores across all comps
df_usaw_scores <- df_usaw[,c('FullName', 'Apparatus', 'Score')] %>%
  arrange(desc(Score)) %>%
  distinct(FullName, Apparatus, .keep_all = TRUE) %>%
  pivot_wider(names_from = Apparatus, values_from = Score)

head(df_usaw_scores)
```


```{r}
# some high correlations, especially for vault, balance beam, and floor exercises (all positive)
# uneven bars are the exception 
cor(df_usaw_scores[,c('VT', 'VT1', 'VT2', 'UB', 'BB', 'FX')], use = "complete.obs")
```

```{r}
# outlier in UB
ggplot(df_usaw_scores, aes(x = VT, y = UB)) +
  geom_point()
```

### Are All-Around Scores correlated?
Idk how to check
```{r}
 df_usaw %>%
  select('FullName', 'Competition', 'Round', 'Score') %>%
  filter(Round == 'AAfinal') %>%
  arrange(Competition)
```


### Vault

```{r}
# selecting athletes that had won 5th place or higher at least once, selecting highest score across competitions 
df_usaw_vt <- df_usaw %>%
  filter(stringr::str_like(Apparatus,'VT%'))

df_usaw_vt_bestscore <- df_usaw_vt %>%
  arrange(desc(Score)) %>%
  distinct(FullName, Round, .keep_all = TRUE)
```


```{r}
ggplot(df_usaw_vt_bestscore, aes(x = Score))+
  geom_histogram()
```


```{r fig.width = 10}
ggplot(df_usaw_vt_bestscore, mapping = aes(x = Score, y = FullName, fill = Year)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=Score), size = 3.5,  hjust = 1.1) +
  facet_wrap(~Round)
```

Looking at difficulty trends
```{r}
df_usaw_vt_scores <- df_usaw_vt %>%
  select(FullName, Date, D_Score, E_Score, Score)
```

```{r}
ggplot(df_usaw_vt_scores, aes(x = Date, y = D_Score, color = FullName)) + 
  geom_point(alpha = 0.5, size = 3)
```

```{r}
ggplot(df_usaw_vt_scores, aes(x = Date, y = E_Score, color = FullName)) + 
  geom_point(alpha = 0.5, size = 3)
```

### Balance Beam

```{r}
# selecting athletes that had won 5th place or higher at least once, selecting highest score across competitions 
df_usaw_bb <- df_usaw %>%
  filter(stringr::str_like(Apparatus,'BB%') & Rank <= 5) %>%
  arrange(desc(Score)) %>%
  distinct(FullName, Round, .keep_all = TRUE)
```


```{r fig.width = 10}
ggplot(df_usaw_bb, mapping = aes(x = Score, y = FullName, fill = Year)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=Score), size = 3.5,  hjust = 1.1) +
  facet_wrap(~Round)
```


### Uneven Bars

```{r}
# selecting athletes that had won 5th place or higher at least once, selecting highest score across competitions 
df_usaw_ub <- df_usaw %>%
  filter(stringr::str_like(Apparatus,'UB%') & Rank <= 5) %>%
  arrange(desc(Score)) %>%
  distinct(FullName, Round, .keep_all = TRUE)
```


```{r fig.width = 10}
ggplot(df_usaw_ub, mapping = aes(x = Score, y = FullName, fill = Year)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=Score), size = 3.5, hjust = 1.1) +
  facet_wrap(~Round)
```


### Floor Exercise

```{r}
# selecting athletes that had won 5th place or higher at least once, selecting highest score across competitions 
df_usaw_fx <- df_usaw %>%
  filter(stringr::str_like(Apparatus,'FX%') & Rank <= 5) %>%
  arrange(desc(Score)) %>%
  distinct(FullName, Round, .keep_all = TRUE)
```


```{r fig.width = 10}
ggplot(df_usaw_fx, mapping = aes(x = Score, y = FullName, fill = Year)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label=Score), size = 3.5, hjust = 1.1) +
  facet_wrap(~Round)
```




